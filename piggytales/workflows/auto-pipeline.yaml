# PiggyTales Automated Pipeline
# Workflow: auto-pipeline
# Version: 1.0.0
#
# One-prompt-to-publish automated content creation pipeline.
# Triggered by: /tale auto "prompt"

name: auto-pipeline
version: "1.0.0"
description: "Fully automated content creation from single prompt"

# ===========================================
# TRIGGER CONFIGURATION
# ===========================================

triggers:
  commands:
    - "/tale auto"
    - "/tale autopilot"

  input_format:
    pattern: '/tale auto "{prompt}"'
    options:
      - "--research": "Include trend research"
      - "--publish": "Auto-publish when ready"
      - "--platform <p>": "Target platform"
      - "--audience <a>": "Target audience"
      - "--type <t>": "Content type"
      - "--express": "Use express mode (faster, less review)"

  examples:
    - '/tale auto "bedtime story about a brave little fox"'
    - '/tale auto "TikTok video about friendship" --platform tiktok --audience teens'
    - '/tale auto "educational song about colors" --type music-video --publish'

# ===========================================
# PIPELINE STAGES
# ===========================================

stages:
  # ------------------------------------------
  # STAGE 1: INITIALIZATION
  # ------------------------------------------
  1_init:
    name: "Initialize Project"
    agent: project-manager
    auto_approve: true
    timeout: 1m

    actions:
      - parse_input_prompt
      - detect_content_type
      - detect_audience
      - create_project_record
      - initialize_database_entry

    outputs:
      - project_id
      - content_type
      - audience
      - workflow_mode
      - platforms

    display:
      banner: |
        ğŸ·ğŸ„ PIGGYTALES AUTO PIPELINE
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        Starting automated content creation...

  # ------------------------------------------
  # STAGE 2: MARKET RESEARCH
  # ------------------------------------------
  2_research:
    name: "Market Research"
    agent: market-researcher
    auto_approve: true
    timeout: 5m
    skip_if: "--no-research flag"

    inputs:
      - project_id
      - content_type
      - audience
      - platforms

    actions:
      - fetch_trending_topics
      - analyze_competitors
      - find_content_gaps
      - predict_success
      - generate_recommendations

    outputs:
      - trend_report
      - success_probability
      - recommended_angles
      - optimal_timing
      - keywords_hashtags

    gate:
      condition: "success_probability >= 60"
      on_pass: "continue"
      on_fail:
        action: "ask_user"
        message: |
          âš ï¸ Success prediction: {success_probability}%

          This is below our recommended threshold (60%).

          Recommendations:
          {recommendations}

          Options:
          1. Proceed anyway
          2. Adjust content based on recommendations
          3. Cancel and try different topic
        options:
          proceed: "continue"
          adjust: "goto:2_research"
          cancel: "abort"

    display:
      progress: "ğŸ“Š Researching market trends..."
      complete: |
        âœ… Research complete
        ğŸ“ˆ Success prediction: {success_probability}%
        ğŸ¯ Top recommendation: {recommendations[0]}

  # ------------------------------------------
  # STAGE 3: SCRIPT CREATION
  # ------------------------------------------
  3_script:
    name: "Script Creation"
    agents:
      - script-writer
      - emotion-tagger

    parallel: false
    auto_approve: true
    timeout: 10m

    inputs:
      - project_id
      - trend_report
      - recommended_angles
      - audience

    sub_stages:
      3a_write:
        agent: script-writer
        actions:
          - generate_outline
          - write_full_script
          - add_scene_descriptions
          - optimize_for_audience

      3b_emotions:
        agent: emotion-tagger
        depends_on: 3a_write
        actions:
          - analyze_emotional_beats
          - tag_voice_emotions
          - add_sfx_markers
          - create_timing_guide

    review:
      agent: auto-reviewer
      checks:
        - content_safety: required
        - language_appropriate: required
        - brand_voice: required
      on_fail:
        action: "auto_revise"
        max_attempts: 3
        escalate_after: 3

    outputs:
      - full_script
      - emotion_tags
      - timing_guide
      - sfx_markers

    display:
      progress: "âœï¸ Creating script..."
      complete: "âœ… Script complete ({word_count} words)"

  # ------------------------------------------
  # STAGE 4: ASSET PREPARATION
  # ------------------------------------------
  4_assets:
    name: "Asset Preparation"
    agents:
      - prompt-optimizer
      - art-director
      - seo-writer

    parallel: true
    auto_approve: true
    timeout: 5m

    inputs:
      - project_id
      - full_script
      - trend_report
      - platforms

    sub_stages:
      4a_prompts:
        agent: prompt-optimizer
        actions:
          - generate_image_prompts
          - generate_video_prompts
          - generate_music_prompts
          - optimize_for_models

      4b_style:
        agent: art-director
        actions:
          - create_style_guide
          - define_color_palette
          - character_consistency_prompts

      4c_seo:
        agent: seo-writer
        actions:
          - generate_titles
          - write_descriptions
          - compile_tags_hashtags
          - create_thumbnail_concepts

    outputs:
      - optimized_prompts
      - style_guide
      - seo_metadata
      - thumbnail_concepts

    display:
      progress: "ğŸ¨ Preparing assets..."

  # ------------------------------------------
  # STAGE 5: PRODUCTION
  # ------------------------------------------
  5_production:
    name: "Content Production"
    timeout: 30m

    sub_stages:
      5a_voice:
        name: "Voice Generation"
        agent: voice-producer
        api: vbee
        auto_approve: true

        inputs:
          - full_script
          - emotion_tags
          - timing_guide

        actions:
          - prepare_voice_segments
          - call_vbee_api
          - download_audio_files
          - verify_quality

        outputs:
          - voice_files
          - voice_timestamps

        display:
          progress: "ğŸ™ï¸ Generating voice..."

      5b_music:
        name: "Music Generation"
        agent: music-producer
        api: suno
        parallel_with: 5a_voice
        auto_approve: true

        inputs:
          - music_prompts
          - content_mood
          - duration

        actions:
          - call_suno_api
          - download_music
          - verify_quality

        outputs:
          - music_files

        display:
          progress: "ğŸµ Generating music..."

      5c_images:
        name: "Image Generation"
        agent: image-producer
        api: dalle
        parallel_with: 5a_voice
        auto_approve: true
        skip_if: "content_type == audiobook"

        inputs:
          - image_prompts
          - style_guide

        actions:
          - call_dalle_api
          - download_images
          - verify_quality

        outputs:
          - image_files

        display:
          progress: "ğŸ–¼ï¸ Generating images..."

      5d_video:
        name: "Video Generation"
        agent: video-producer
        api: veo3
        depends_on: [5a_voice, 5c_images]
        auto_approve: "quality_score >= 8.0"
        skip_if: "content_type == audiobook"

        inputs:
          - video_prompts
          - voice_files
          - style_guide

        actions:
          - call_veo3_api
          - download_videos
          - verify_quality

        gate:
          condition: "quality_score >= 7.0"
          on_fail:
            action: "regenerate"
            max_attempts: 2

        outputs:
          - video_files

        display:
          progress: "ğŸ¬ Generating video..."

      5e_assembly:
        name: "Audio Assembly"
        agent: audio-engineer
        depends_on: [5a_voice, 5b_music]
        auto_approve: true

        actions:
          - merge_voice_music
          - add_sfx
          - normalize_audio
          - export_final

        outputs:
          - final_audio

        display:
          progress: "ğŸ”§ Assembling audio..."

    display:
      complete: |
        âœ… Production complete
        ğŸ“ Generated assets: {asset_count}

  # ------------------------------------------
  # STAGE 6: REVIEW
  # ------------------------------------------
  6_review:
    name: "Quality Review"
    agent: auto-reviewer
    timeout: 5m

    inputs:
      - all_assets
      - project_config

    actions:
      - safety_scan
      - quality_assessment
      - brand_check
      - platform_compliance

    council:
      enabled: true
      mode: "quick"  # quick|standard|deep
      threshold: 7.0

    scores:
      - safety_score: required >= 100
      - quality_score: required >= 7.0
      - brand_score: required >= 75

    gate:
      condition: "safety_score == 100 AND quality_score >= 7.0 AND brand_score >= 75"
      on_pass: "continue"
      on_fail:
        condition: "safety_score < 100"
        action: "block"
        message: "Safety issue detected. Human review required."
        else:
          action: "human_review"
          message: "Quality below threshold. Please review."

    outputs:
      - review_report
      - final_scores
      - approval_status

    display:
      complete: |
        âœ… Review complete
        ğŸ›¡ï¸ Safety: {safety_score}%
        â­ Quality: {quality_score}/10
        ğŸ¨ Brand: {brand_score}%

  # ------------------------------------------
  # STAGE 7: PUBLISH
  # ------------------------------------------
  7_publish:
    name: "Schedule & Publish"
    agent: content-scheduler
    skip_if: "not --publish flag"
    auto_approve: "6_review passed"
    timeout: 5m

    inputs:
      - final_assets
      - seo_metadata
      - platforms
      - optimal_timing

    actions:
      - prepare_platform_content
      - upload_to_platforms
      - schedule_or_publish
      - update_database

    platforms:
      youtube:
        enabled: true
        settings:
          privacy: "public"
          made_for_kids: true
          schedule: "optimal"

      tiktok:
        enabled: "audience in [teenagers, young-adult]"
        settings:
          privacy: "public"

      youtube_shorts:
        enabled: "duration <= 60"
        settings:
          privacy: "public"

    outputs:
      - publication_ids
      - platform_urls
      - scheduled_times

    display:
      complete: |
        ğŸ‰ Published successfully!
        {platform_urls}

  # ------------------------------------------
  # STAGE 8: TRACKING
  # ------------------------------------------
  8_track:
    name: "Analytics Setup"
    agent: analytics-tracker
    auto_approve: true
    timeout: 1m

    actions:
      - schedule_analytics_fetches
      - set_milestone_notifications
      - initialize_tracking

    schedule:
      first_check: "1 hour after publish"
      regular_checks: ["6h", "24h", "7d"]

    notifications:
      milestones:
        - views: 100
        - views: 1000
        - views: 10000
      alerts:
        - viral_potential: true
        - underperforming: true

    display:
      complete: "ğŸ“Š Analytics tracking enabled"

# ===========================================
# PIPELINE CONFIGURATION
# ===========================================

config:
  default_mode: "standard"  # express|lite|standard|full

  modes:
    express:
      skip_stages: [2_research, 4_assets.4b_style]
      quality_threshold: 6.0
      council_mode: "none"

    lite:
      skip_stages: [2_research]
      quality_threshold: 7.0
      council_mode: "quick"

    standard:
      skip_stages: []
      quality_threshold: 7.5
      council_mode: "quick"

    full:
      skip_stages: []
      quality_threshold: 8.0
      council_mode: "standard"
      human_review: true

  error_handling:
    on_stage_failure:
      max_retries: 2
      retry_delay: "10s"
      escalate_after: 2

    on_api_failure:
      max_retries: 3
      retry_delay: "exponential"
      fallback: "skip_if_optional"

    on_timeout:
      action: "pause"
      notify: true

  logging:
    level: "info"
    save_to: "database"
    include_prompts: true
    include_api_responses: false  # For cost tracking

# ===========================================
# SUCCESS CRITERIA
# ===========================================

success_criteria:
  required:
    - safety_score: 100
    - all_required_assets: true
    - review_passed: true

  optional:
    - published: true
    - quality_score: ">= 8.0"
    - viral_score: ">= 7.0"

# ===========================================
# OUTPUT SUMMARY
# ===========================================

output:
  format: "summary"

  display: |
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ·ğŸ„ PIGGYTALES AUTO PIPELINE COMPLETE
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    ğŸ“Œ Project: {project_title}
    ğŸ“ Type: {content_type}
    ğŸ‘¥ Audience: {audience}

    ğŸ“Š Scores:
       Safety: {safety_score}%
       Quality: {quality_score}/10
       Viral: {viral_score}/10

    ğŸ“¦ Assets Generated:
       {asset_summary}

    ğŸŒ Published To:
       {publication_summary}

    â±ï¸ Total Time: {total_time}
    ğŸ’° Estimated Cost: ${estimated_cost}

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  save_to:
    - database: true
    - local_file: "reports/auto-{project_id}-{timestamp}.json"
